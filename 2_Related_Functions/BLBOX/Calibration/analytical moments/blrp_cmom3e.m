%%  function to calculate 3rd central moment for BL original model with random eta, truncated
%  Gamma version (epsilon model)

function thirdmoment = blrp_cmom3e(theta,h)
eps=0;
lambda=theta(:,1);
kappa=theta(:,2);
phi=theta(:,3);
alpha=theta(:,4);
nu=theta(:,5);
p=theta(:,6);
delta=theta(:,7);

muc=1+kappa./phi;
mux=p.*delta./(delta-1);
var=p.^2.*delta./(delta-1).^2/(delta-2);
skw=sqrt((delta-2)./delta).*2.*(delta+1)./(delta-3);

mux2=var+mux.^2;
cmom3=skw.*var.^(3/2);
mux3=cmom3+3.*var.*mux+mux.^3;


    p1 = Exp_fn_e(4,h,eps,nu,alpha) .* (12.*phi.^7.*mux.^3.*kappa.^2 - 24.*mux.*mux2.*phi.^2.*kappa - ...
    18.*phi.^4.*mux.^3.*kappa.^2 + 24.*mux.*mux2.*phi.^3.*kappa - 132.*mux.*mux2.*phi.^6.*kappa + ...
    150.*mux.*mux2.*phi.^4.*kappa - 42.*phi.^5.*mux.^3.*kappa.^2 - 6.*mux.*mux2.*phi.^5.*kappa + ...
    108.*phi.^5.*mux3 - 72.*phi.^7.*mux3 - 48.*mux3.*phi.^3 + 24.*mux2.*mux.*phi.^8.*kappa + ...
    12.*phi.^3.*mux.^3.*kappa.^2 + 12.*phi.^9.*mux3);

   p2 = Exp_fn_e(3,h,eps,nu,alpha) .* (24.*mux.*mux2.*phi.^4.*h.*kappa + 6.*phi.^9.*h.*mux3 - ...
      30.*mux.*mux2.*phi.^6.*h.*kappa + 6.*mux.*mux2.*phi.^8.*h.*kappa + 54.*phi.^5.*h.*mux3 - ...
      24.*h.*mux3.*phi.^3 - 36.*phi.^7.*h.*mux3);

   p3= Exp_fn_e(4,phi.*h,eps,nu,alpha).*( -48.*mux.^3.*kappa.^2 + 6.*mux.*mux2.*phi.^4.*kappa - ...
       48.*phi.*mux.*mux2.*kappa + 6.*phi.^5.*mux.^3.*kappa.^2 - 24.*mux.*mux2.*phi.^2.*kappa + ...
       36.*mux.*mux2.*phi.^3.*kappa - 6.*mux.*mux2.*phi.^5.*kappa + 84.*phi.^2.*mux.^3.*kappa.^2 + ...
       12.*phi.^3.*mux.^3.*kappa.^2 - 18.*phi.^4.*mux.^3.*kappa.^2);

   p4 = Exp_fn_e(3,phi.*h,eps,nu,alpha) .* (-24.*phi.*h.*mux.^3.*kappa.^2 + 30.*phi.^3.*h.*mux.^3.*kappa.^2 - ...
       6.*phi.^5.*h.*mux.^3.*kappa.^2);

   p5 = Exp_fn_e(4,0,eps,nu,alpha) .* (72.*phi.^7.*mux3 + 48.*phi.*mux.*mux2.*kappa + ...
        24.*mux.*mux2.*phi.^2.*kappa - 36.*mux.*mux2.*phi.^3.*kappa - 84.*phi.^2.*mux.^3.*kappa.^2 + ...
        6.*mux.*mux2.*phi.^5.*kappa + 117.*mux.*mux2.*phi.^6.*kappa + 39.*phi.^5.*mux.^3.*kappa.^2 - ...
        12.*phi.^9.*mux3 - 138.*mux.*mux2.*phi.^4.*kappa + 48.*mux.^3.*kappa.^2 - ...
        9.*phi.^7.*mux.^3.*kappa.^2 + 48.*phi.^3.*mux3 + 18.*phi.^4.*mux.^3.*kappa.^2 - ...
        21.*phi.^8.*mux2.*mux.*kappa - 12.*phi.^3.*mux.^3.*kappa.^2 - 108.*phi.^5.*mux3);

   p6 = Exp_fn_e(3,0,eps,nu,alpha) .* (-24.*phi.*h.*mux.^3.*kappa.^2 - 72.*mux.*mux2.*phi.^6.*h.*kappa - ...
        36.*phi.^5.*h.*mux.^3.*kappa.^2 + 54.*phi.^3.*h.*mux.^3.*kappa.^2 + 6.*phi.^7.*h.*mux.^3.*kappa.^2 + ...
        54.*phi.^5.*h.*mux3 - 36.*phi.^7.*h.*mux3 - 24.*phi.^3.*h.*mux3 - 48.*mux.*mux2.*phi.^2.*h.*kappa + ...
        12.*mux.*mux2.*phi.^8.*h.*kappa + 6.*phi.^9.*h.*mux3 + 108.*mux.*mux2.*phi.^4.*h.*kappa);

   p7 = Exp_fn_e(4,2.*h,eps,nu,alpha) .* (-12.*mux2.*mux.*phi.^4.*kappa - 3.*mux2.*mux.*phi.^8.*kappa + ...
         15.*mux2.*mux.*phi.^6.*kappa - 3.*phi.^7.*mux.^3.*kappa.^2 + 3.*phi.^5.*mux.^3.*kappa.^2);

   p8 = Exp_fn_e(4,h.*(1+phi),eps,nu,alpha) .* ( -24.*mux2.*mux.*kappa.*phi.^3 - 6.*mux2.*mux.*phi.^4.*kappa + ...
         6.*phi.^5.*mux2.*mux.*kappa + 24.*mux2.*mux.*kappa.*phi.^2 + 18.*phi.^4.*mux.^3.*kappa.^2 - ...
         12.*phi.^3.*mux.^3.*kappa.^2 - 6.*phi.^5.*mux.^3.*kappa.^2);

   thirdmoment=(p1+p2+p3+p4+p5+p6+p7+p8).*lambda.*muc ./ ...
     ((1 + 2.*phi + phi.^2).*(phi.^4 - 2.*phi.^3 - 3.*phi.^2 +8.*phi - 4).*phi.^3);

% thirdmoment=thirdmoment-3*TBL_avg(theta,h).*TBL_var(theta,h)-TBL_avg(theta,h)^3;